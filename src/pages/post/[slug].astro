---
import type { Slug, Categories, Tags } from "@lib/types";
import Layout from "@layouts/Layout.astro";
import { getPostInfo, getAllPostsSlugs, getPostsByCategory } from "@lib/wp";
import RelatedPosts from "@components/posts/RelatedPosts.astro";

const { slug } = Astro.params as { slug: Slug };
if (!slug) return Astro.redirect("/404");

// Just if the blog has small amount of posts use getStaticPaths if not use render: server
export async function getStaticPaths() {
  const slugs: Slug[] = await getAllPostsSlugs();
  return slugs.map((slug) => ({ params: { slug } }));
}

const postInfo = await getPostInfo(slug);

if (!postInfo) {
  return [];
}

const { title, content, featuredImage, date, author, categories, tags } =
  postInfo;

const isAdmin = author === "admin";

const categoryIds = categories.map((cate: Categories) => cate.id);

const relatedPosts = await getPostsByCategory({ perPage: 3 }, { categoryIds });
const hasRelatedPosts = relatedPosts.length > 1;

const formattedDate = new Date(date).toLocaleDateString("en-US", {
  month: "long",
  day: "2-digit",
  year: "numeric",
});
---

<Layout title={title}>
  <main
    class="max-w-7xl mx-auto text-center px-4 py-4 sm:px-6 lg:px-8 font-plusjakarta"
  >
    <header class="mb-4">
      <h1
        class="font-plusjakarta text-3xl md:text-5xl font-bold text-primary-text tracking-wider mb-4"
      >
        {title}
      </h1>
      <p class="text-text-light font-inter font-light text-xs md:text-sm">
        Writen by: {isAdmin && "Milja Pekkala"} | Published on {formattedDate}
      </p>
    </header>

    <section class="max-w-5xl mx-auto xl w-full flex flex-col gap-3 mb-4">
      <img
        class="w-full object-cover rounded-xl h-96 md:h-[500px]"
        src={featuredImage}
        alt={title}
        transition:name="picture"
      />
      <div class="flex justify-center items-center gap-2">
        <p
          class="font-plusjakarta font-light text-text-light text-xs md:text-sm"
        >
          Categories:
        </p>
        {
          categories.map((cat: Categories, index: number) => (
            <>
              <nav class="font-plusjakarta font-light text-text-light hover:text-primary-text text-xs md:text-sm">
                <a href={`/category/${cat.slug}`} class="no-underline">
                  {cat.name}
                </a>
              </nav>
              {index < categories.length - 1 ? " - " : " "}
            </>
          ))
        }
      </div>
    </section>

    <article class="prose max-w-5xl mx-auto text-secondary-text text-left">
      <div class="font-plusjakarta font-normal text-md" set:html={content} />

      <div class="flex justify-center items-center gap-2">
        <p
          class="font-plusjakarta font-light text-text-light text-xs md:text-sm"
        >
          Tags:
        </p>
        {
          tags.map((tag: Tags) => (
            <nav class="font-plusjakarta font-light text-xs md:text-sm">
              <a
                class="no-underline font-light text-text-light hover:text-primary-text text-xs md:text-sm"
                href={`/tags/${tag.slug}`}
              >
                {tag.name}
              </a>
            </nav>
          ))
        }
      </div>
    </article>
  </main>

  {hasRelatedPosts && <RelatedPosts posts={relatedPosts} currentSlug={slug} />}
</Layout>
