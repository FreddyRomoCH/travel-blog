---
import Banner from "@components/banner/Banner.astro";
import AllPosts from "@components/posts/AllPosts.astro";
import Layout from "@layouts/Layout.astro";
import type { Category, Slug } from "@lib/types";
import { getAllPostsTags, getPageInfo, getPostsByTags } from "@lib/wp";

export async function getStaticPaths() {
  const tags = await getAllPostsTags();
  return tags.map((tag: Category) => ({
    params: { tag: tag.slug },
    props: { id: tag.id },
  }));
}

const { tag } = Astro.params as { tag: Slug };
const { id } = Astro.props as { id: number };

const tagsPageInfo = await getPageInfo("tags");

const posts = await getPostsByTags({ perPage: 3 }, { tagIds: [id] });

const pageExists = tagsPageInfo && posts.length > 0;
---

{
  pageExists && (
    <Layout title={`Tag - ${tag}`}>
      <Banner
        title={tagsPageInfo.title}
        content={tagsPageInfo.content}
        featuredImage={tagsPageInfo.featuredImage}
      />
      <AllPosts posts={posts} />
    </Layout>
  )
}

{!pageExists && Astro.redirect("/404")}
