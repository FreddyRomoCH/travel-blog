---
import { getAllPosts, getPageInfo } from "@lib/wp";
import Layout from "@layouts/Layout.astro";
import Banner from "@components/banner/Banner.astro";
import AllPosts from "@components/posts/AllPosts.astro";

export async function getStaticPaths() {
  const allPostsInfo = await getAllPosts({ page: 1, perPage: 6 });

  if (!allPostsInfo) {
    return [];
  }

  return Array.from({ length: allPostsInfo.totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
  }));
}

const currentPage = Number(Astro.params.page) || 1;
const perPage = 6;

// const { posts, totalPages } = await getAllPosts({
const allPostsInfo = await getAllPosts({
  page: currentPage,
  perPage,
});

if (!allPostsInfo) {
  Astro.response.status = 404;
}

const prevPage = currentPage > 1 ? currentPage - 1 : null;
const nextPage =
  allPostsInfo && currentPage < allPostsInfo.totalPages
    ? currentPage + 1
    : null;

const pageInfo = await getPageInfo("my-posts");
---

<Layout title={pageInfo?.title || "My Posts"}>
  <Banner
    title={pageInfo?.title || "My Posts"}
    content={pageInfo?.content || ""}
    featuredImage={pageInfo?.featuredImage || null}
    pageName="my-posts"
  />

  <AllPosts posts={allPostsInfo?.posts} />

  <nav class="flex justify-center gap-4 my-6">
    {
      prevPage && (
        <a
          href={`/my-posts/${prevPage}`}
          class="px-4 py-2 bg-primary hover:bg-primary-dark rounded-lg shadow text-sm font-inter font-light text-base"
        >
          ← Previous
        </a>
      )
    }
    <span class="px-4 py-2 text-sm text-primary-text font-inter font-light">
      Page {currentPage} of {allPostsInfo?.totalPages}
    </span>
    {
      nextPage && (
        <a
          href={`/my-posts/${nextPage}`}
          class="px-4 py-2 bg-primary hover:bg-primary-dark rounded-lg shadow text-sm font-inter font-light text-base"
        >
          Next →
        </a>
      )
    }
  </nav>
</Layout>
